{"version":3,"sources":["file:///E:/04Project/Cocos/00Demos/Portal/assets/script/v2/PlayerCtrl.ts"],"names":["_decorator","Component","Node","input","Input","BoxCollider","RigidBody","KeyCode","v3","Vec3","clamp","ccclass","property","PlayerCtrl","playerCamera","RigidBodyComponent","ColliderComponent","canMovePerspect","canJump","playerAngel","start","instance","Player","getChildByName","getComponent","on","EventType","KEY_DOWN","playerStartMove","KEY_PRESSING","KEY_UP","playerStopMove","MOUSE_MOVE","moveView","MOUSE_DOWN","MOUSE_UP","playerLand","worldRotation","getEulerAngles","event","delta","getDelta","percentage","x","y","setWorldRotationFromEuler","speed","v","getLinearVelocity","keyCode","KEY_W","z","KEY_A","KEY_S","KEY_D","SPACE","applyForce","transformQuat","getWorldRotation","setLinearVelocity"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, input, Input, BoxCollider, RigidBody, EventKeyboard, KeyCode, EventMouse, v3, ICollisionEvent, Vec3, clamp } from 'cc';\nconst { ccclass, property } = _decorator;\n\n@ccclass('PlayerCtrl')\nexport class PlayerCtrl extends Component {\n    //玩家节点\n    @property(Node)\n    Player:Node = null !\n\n    //摄像机节点\n    public playerCamera:Node; \n    //刚体组件\n    public RigidBodyComponent:RigidBody;\n    //碰撞箱组件\n    private ColliderComponent:BoxCollider;\n    //是否可以移动视角\n    private canMovePerspect = false;\n    //是否可以跳跃\n    private canJump = false;\n    //玩家视角\n    public playerAngel = v3();\n    // 单例\n    public static instance:PlayerCtrl = null!\n\n    start() {\n        // 绑定单例\n        PlayerCtrl.instance = this;\n        //获取摄像机\n        this.playerCamera = this.Player.getChildByName(\"Main Camera\")\n        // 获取组件\n        this.RigidBodyComponent = this.Player.getComponent(RigidBody);\n        this.ColliderComponent = this.Player.getComponent(BoxCollider);\n        // 开启按键监听\n        input.on(Input.EventType.KEY_DOWN,this.playerStartMove,this);\n        input.on(Input.EventType.KEY_PRESSING,this.playerStartMove,this);\n        input.on(Input.EventType.KEY_UP,this.playerStopMove,this);\n        input.on(Input.EventType.MOUSE_MOVE,this.moveView,this);\n        input.on(Input.EventType.MOUSE_DOWN,()=>{\n            this.canMovePerspect = true;//按下鼠标后可以移动视角\n        },this);\n        input.on(Input.EventType.MOUSE_UP,()=>{\n            this.canMovePerspect = false;//松开鼠标后不能移动视角\n        },this);\n        // 开启碰撞检测\n        this.ColliderComponent.on(\"onCollisionEnter\",this.playerLand,this);\n        // 获取角度\n        this.playerCamera.worldRotation.getEulerAngles(this.playerAngel);\n    }\n\n    moveView(event:EventMouse){//移动视角\n        if(!this.canMovePerspect) return;//判断是否可以移动视角\n        let delta = event.getDelta();//鼠标移动距离，右上为正        \n        let percentage = 0.5;//灵敏度\n        let x = delta.x*percentage;\n        let y = delta.y*percentage;\n        if(this.playerAngel.y-x>180){\n            this.playerAngel.y -= 360;\n        }\n        else if(this.playerAngel.y-x<-180){\n            this.playerAngel.y += 360;\n        }\n        this.playerCamera.setWorldRotationFromEuler(clamp(this.playerAngel.x+y,-90,90),this.playerAngel.y-x,0);\n        this.playerCamera.worldRotation.getEulerAngles(this.playerAngel);//更新人物角度朝向信息供移动函数使用\n        \n    }\n\n    playerLand(event:ICollisionEvent){//玩家着陆\n        this.canJump = true;\n    }\n\n    // 这样的实现有bug，一次只能按一个键，按多了就会变得奇奇怪怪\n    playerStartMove(event:EventKeyboard){//玩家开始移动\n        let speed = 10;\n        let v = v3();\n        this.RigidBodyComponent.getLinearVelocity(v);\n        switch(event.keyCode){\n            case KeyCode.KEY_W:\n                // console.log(\"press W\");\n                v.z = -speed;\n                v.x = 0;\n                break;\n            case KeyCode.KEY_A:\n                // console.log(\"press A\");\n                v.x = -speed;\n                v.z = 0;\n                break;\n            case KeyCode.KEY_S:\n                // console.log(\"press S\");\n                v.z = speed;\n                v.x = 0;\n                break;\n            case KeyCode.KEY_D:\n                // console.log(\"press D\");\n                v.x = speed;\n                v.z = 0;\n                break;\n            case KeyCode.SPACE:\n                // console.log(\"press Space\");\n                if(this.canJump){\n                    this.RigidBodyComponent.applyForce(v3(0,300,0));\n                    this.canJump = false;\n                }\n                break;\n        }\n        if(event.keyCode!=KeyCode.SPACE){\n            Vec3.transformQuat(v,v,this.playerCamera.getWorldRotation());\n            if(v.y>0){\n                v.y = 0;\n            }\n            this.RigidBodyComponent.setLinearVelocity(v);\n        }\n        \n    }\n\n    playerStopMove(event:EventKeyboard){//玩家停止移动\n        switch(event.keyCode){\n            case KeyCode.KEY_W:\n            case KeyCode.KEY_A:\n            case KeyCode.KEY_S:\n            case KeyCode.KEY_D:\n                this.RigidBodyComponent.setLinearVelocity(v3(0,0,0));\n        }\n    }\n}\n"]}