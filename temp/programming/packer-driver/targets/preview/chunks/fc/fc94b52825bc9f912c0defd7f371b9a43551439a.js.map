{"version":3,"sources":["file:///E:/04Project/Cocos/Portal/assets/script/v1/PlayerCtrl.ts"],"names":["_decorator","Component","Node","input","Input","BoxCollider","RigidBody","Camera","PhysicsSystem","KeyCode","v3","instantiate","Vec3","clamp","Prefab","Quat","ccclass","property","PlayerCtrl","RigidBodyComponent","ColliderComponent","CameraComponent","canMovePerspect","canJump","playerAngel","start","Player","getComponent","playerCamera","on","EventType","KEY_DOWN","playerStartMove","detectRayCollide","KEY_PRESSING","KEY_UP","playerStopMove","MOUSE_MOVE","moveView","MOUSE_DOWN","MOUSE_UP","playerLand","eulerAngles","event","ray","screenPointToRay","pos","normal","dir","instance","raycastClosest","element","raycastClosestResult","console","log","hitPoint","hitNormal","fromViewUp","keyCode","KEY_E","node","pref","GameScene","addChild","setPosition","setRotation","delta","getDelta","percentage","x","y","setRotationFromEuler","z","speed","v","getLinearVelocity","KEY_W","KEY_A","KEY_S","KEY_D","SPACE","applyForce","transformQuat","getRotation","setLinearVelocity","KEY_Q"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, input, Input, BoxCollider, RigidBody, Camera, EventKeyboard, PhysicsSystem, KeyCode, EventMouse, v3, instantiate, ICollisionEvent, Vec3, clamp, Prefab, Quat } from 'cc';\nconst { ccclass, property } = _decorator;\n\n@ccclass('PlayerCtrl')\nexport class PlayerCtrl extends Component {\n    //玩家节点\n    @property(Node)\n    Player:Node = null!\n    //摄像机节点\n    @property(Node)\n    playerCamera:Node = null!   \n    //场景节点\n    @property(Node)\n    GameScene:Node = null!\n    //预制件\n    @property(Prefab)\n    pref:Prefab = null!\n\n    //刚体组件\n    private RigidBodyComponent:RigidBody;\n    //碰撞箱组件\n    private ColliderComponent:BoxCollider;\n    //摄像机组件\n    private CameraComponent:Camera;\n    //是否可以移动视角\n    private canMovePerspect = false;\n    //是否可以跳跃\n    private canJump = false;\n    //玩家视角\n    private playerAngel = v3();\n\n    start() {\n        // 获取组件\n        this.RigidBodyComponent = this.Player.getComponent(RigidBody);\n        this.ColliderComponent = this.Player.getComponent(BoxCollider);\n        this.CameraComponent = this.playerCamera.getComponent(Camera);\n        // 开启监听\n        input.on(Input.EventType.KEY_DOWN,this.playerStartMove,this);\n        input.on(Input.EventType.KEY_DOWN,this.detectRayCollide,this);\n        input.on(Input.EventType.KEY_PRESSING,this.playerStartMove,this);\n        input.on(Input.EventType.KEY_UP,this.playerStopMove,this);\n        input.on(Input.EventType.MOUSE_MOVE,this.moveView,this);\n        input.on(Input.EventType.MOUSE_DOWN,()=>{\n            this.canMovePerspect = true;//按下鼠标后可以移动视角\n        },this)\n        input.on(Input.EventType.MOUSE_UP,()=>{\n            this.canMovePerspect = false;//松开鼠标后不能移动视角\n        },this)\n\n        this.ColliderComponent.on(\"onCollisionEnter\",this.playerLand,this);\n        // 获取角度\n        this.playerAngel = this.playerCamera.eulerAngles;\n    }\n\n    detectRayCollide(event:EventKeyboard){// 屏幕射线检测\n        \n        let ray = this.CameraComponent.screenPointToRay(960,530);\n        let pos:Vec3;\n        let normal:Vec3;\n        let dir = new Quat();\n        if(PhysicsSystem.instance.raycastClosest(ray)){\n            const element = PhysicsSystem.instance.raycastClosestResult;\n            console.log(\"founded\");\n            pos = element.hitPoint;\n            normal = element.hitNormal;\n            Quat.fromViewUp(dir,normal,v3(0,1,0));//   \n        }\n        else{\n            console.log(\"not founded\");\n            return;\n        }\n        \n        switch(event.keyCode){\n            case KeyCode.KEY_E:\n                console.log(\"press E\");\n                let node = instantiate(this.pref);\n                this.GameScene.addChild(node);\n                node.setPosition(pos);\n                node.setRotation(dir);\n                break;\n        }\n    }\n\n\n\n    moveView(event:EventMouse){//移动视角\n        if(!this.canMovePerspect) return;//判断是否可以移动视角\n        let delta = event.getDelta();//鼠标移动距离，右上为正        \n        let percentage = 0.5;//灵敏度\n        let x = delta.x*percentage;\n        let y = delta.y*percentage;\n        if(this.playerAngel.y-x>360){\n            this.playerAngel.y -= 360;\n        }\n        else if(this.playerAngel.y-x<-360){\n            this.playerAngel.y += 360;\n        }\n        this.playerCamera.setRotationFromEuler(v3(clamp(this.playerAngel.x+y,-90,90),this.playerAngel.y-x,this.playerAngel.z));\n        this.playerAngel = this.playerCamera.eulerAngles;\n        \n    }\n\n\n\n    playerLand(event:ICollisionEvent){//玩家着陆\n        this.canJump = true;\n    }\n\n    // 这样的实现有bug，一次只能按一个键，按多了就会变得奇奇怪怪\n    playerStartMove(event:EventKeyboard){//玩家开始移动\n        let speed = 10;\n        let v = v3();\n        this.RigidBodyComponent.getLinearVelocity(v);\n        switch(event.keyCode){\n            case KeyCode.KEY_W:\n                console.log(\"press W\");\n                v.z = -speed;\n                v.x = 0;\n                break;\n            case KeyCode.KEY_A:\n                console.log(\"press A\");\n                v.x = -speed;\n                v.z = 0;\n                break;\n            case KeyCode.KEY_S:\n                console.log(\"press S\");\n                v.z = speed;\n                v.x = 0;\n                break;\n            case KeyCode.KEY_D:\n                console.log(\"press D\");\n                v.x = speed;\n                v.z = 0;\n                break;\n            case KeyCode.SPACE:\n                console.log(\"press Space\");\n                if(this.canJump){\n                    this.RigidBodyComponent.applyForce(v3(0,300,0));\n                    this.canJump = false;\n                }\n                break;\n        }\n        if(event.keyCode!=KeyCode.SPACE){\n            Vec3.transformQuat(v,v,this.playerCamera.getRotation())\n            v.y = 0;\n            this.RigidBodyComponent.setLinearVelocity(v)\n        }\n        \n    }\n\n    playerStopMove(event:EventKeyboard){//玩家停止移动\n        switch(event.keyCode){\n            case KeyCode.KEY_W:\n            case KeyCode.KEY_A:\n            case KeyCode.KEY_S:\n            case KeyCode.KEY_D:\n            case KeyCode.KEY_E:\n            case KeyCode.KEY_Q:\n                this.RigidBodyComponent.setLinearVelocity(v3(0,0,0));\n        }\n    }\n\n\n}\n"]}