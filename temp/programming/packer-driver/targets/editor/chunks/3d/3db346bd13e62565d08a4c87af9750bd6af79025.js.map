{"version":3,"sources":["file:///E:/04Project/Cocos/Portal/assets/script/v2/PlayerCtrl.ts"],"names":["_decorator","Component","Node","input","Input","BoxCollider","RigidBody","KeyCode","v3","Vec3","clamp","ccclass","property","PlayerCtrl","RigidBodyComponent","ColliderComponent","canMovePerspect","canJump","playerAngel","start","instance","Player","getComponent","on","EventType","KEY_DOWN","playerStartMove","KEY_PRESSING","KEY_UP","playerStopMove","MOUSE_MOVE","moveView","MOUSE_DOWN","MOUSE_UP","playerLand","playerCamera","worldRotation","getEulerAngles","event","delta","getDelta","percentage","x","y","setWorldRotationFromEuler","speed","v","getLinearVelocity","keyCode","KEY_W","z","KEY_A","KEY_S","KEY_D","SPACE","applyForce","transformQuat","getWorldRotation","setLinearVelocity"],"mappings":";;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,S,OAAAA,S;AAA0BC,MAAAA,O,OAAAA,O;AAAqBC,MAAAA,E,OAAAA,E;AAAqBC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,K,OAAAA,K;;;;;;;;;OACrI;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBZ,U;;4BAGjBa,U,WADZF,OAAO,CAAC,YAAD,C,UAGHC,QAAQ,CAACV,IAAD,C,UAGRU,QAAQ,CAACV,IAAD,C,UAGRU,QAAQ,CAACV,IAAD,C,sCATb,MACaW,UADb,SACgCZ,SADhC,CAC0C;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAY/Ba,kBAZ+B;AAAA,eAc9BC,iBAd8B;AAAA,eAgB9BC,eAhB8B,GAgBZ,KAhBY;AAAA,eAkB9BC,OAlB8B,GAkBpB,KAlBoB;AAAA,eAoB/BC,WApB+B,GAoBjBV,EAAE,EApBe;AAAA;;AAwBtCW,QAAAA,KAAK,GAAG;AACJ;AACAN,UAAAA,UAAU,CAACO,QAAX,GAAsB,IAAtB,CAFI,CAGJ;;AACA,eAAKN,kBAAL,GAA0B,KAAKO,MAAL,CAAYC,YAAZ,CAAyBhB,SAAzB,CAA1B;AACA,eAAKS,iBAAL,GAAyB,KAAKM,MAAL,CAAYC,YAAZ,CAAyBjB,WAAzB,CAAzB,CALI,CAMJ;;AACAF,UAAAA,KAAK,CAACoB,EAAN,CAASnB,KAAK,CAACoB,SAAN,CAAgBC,QAAzB,EAAkC,KAAKC,eAAvC,EAAuD,IAAvD;AACAvB,UAAAA,KAAK,CAACoB,EAAN,CAASnB,KAAK,CAACoB,SAAN,CAAgBG,YAAzB,EAAsC,KAAKD,eAA3C,EAA2D,IAA3D;AACAvB,UAAAA,KAAK,CAACoB,EAAN,CAASnB,KAAK,CAACoB,SAAN,CAAgBI,MAAzB,EAAgC,KAAKC,cAArC,EAAoD,IAApD;AACA1B,UAAAA,KAAK,CAACoB,EAAN,CAASnB,KAAK,CAACoB,SAAN,CAAgBM,UAAzB,EAAoC,KAAKC,QAAzC,EAAkD,IAAlD;AACA5B,UAAAA,KAAK,CAACoB,EAAN,CAASnB,KAAK,CAACoB,SAAN,CAAgBQ,UAAzB,EAAoC,MAAI;AACpC,iBAAKhB,eAAL,GAAuB,IAAvB,CADoC,CACR;AAC/B,WAFD,EAEE,IAFF;AAGAb,UAAAA,KAAK,CAACoB,EAAN,CAASnB,KAAK,CAACoB,SAAN,CAAgBS,QAAzB,EAAkC,MAAI;AAClC,iBAAKjB,eAAL,GAAuB,KAAvB,CADkC,CACL;AAChC,WAFD,EAEE,IAFF,EAdI,CAiBJ;;AACA,eAAKD,iBAAL,CAAuBQ,EAAvB,CAA0B,kBAA1B,EAA6C,KAAKW,UAAlD,EAA6D,IAA7D,EAlBI,CAmBJ;;AACA,eAAKC,YAAL,CAAkBC,aAAlB,CAAgCC,cAAhC,CAA+C,KAAKnB,WAApD;AACH;;AAEDa,QAAAA,QAAQ,CAACO,KAAD,EAAkB;AAAC;AACvB,cAAG,CAAC,KAAKtB,eAAT,EAA0B,OADJ,CACW;;AACjC,cAAIuB,KAAK,GAAGD,KAAK,CAACE,QAAN,EAAZ,CAFsB,CAEO;;AAC7B,cAAIC,UAAU,GAAG,GAAjB,CAHsB,CAGD;;AACrB,cAAIC,CAAC,GAAGH,KAAK,CAACG,CAAN,GAAQD,UAAhB;AACA,cAAIE,CAAC,GAAGJ,KAAK,CAACI,CAAN,GAAQF,UAAhB;;AACA,cAAG,KAAKvB,WAAL,CAAiByB,CAAjB,GAAmBD,CAAnB,GAAqB,GAAxB,EAA4B;AACxB,iBAAKxB,WAAL,CAAiByB,CAAjB,IAAsB,GAAtB;AACH,WAFD,MAGK,IAAG,KAAKzB,WAAL,CAAiByB,CAAjB,GAAmBD,CAAnB,GAAqB,CAAC,GAAzB,EAA6B;AAC9B,iBAAKxB,WAAL,CAAiByB,CAAjB,IAAsB,GAAtB;AACH;;AACD,eAAKR,YAAL,CAAkBS,yBAAlB,CAA4ClC,KAAK,CAAC,KAAKQ,WAAL,CAAiBwB,CAAjB,GAAmBC,CAApB,EAAsB,CAAC,EAAvB,EAA0B,EAA1B,CAAjD,EAA+E,KAAKzB,WAAL,CAAiByB,CAAjB,GAAmBD,CAAlG,EAAoG,CAApG;AACA,eAAKP,YAAL,CAAkBC,aAAlB,CAAgCC,cAAhC,CAA+C,KAAKnB,WAApD,EAbsB,CAa2C;AAEpE;;AAEDgB,QAAAA,UAAU,CAACI,KAAD,EAAuB;AAAC;AAC9B,eAAKrB,OAAL,GAAe,IAAf;AACH,SAlEqC,CAoEtC;;;AACAS,QAAAA,eAAe,CAACY,KAAD,EAAqB;AAAC;AACjC,cAAIO,KAAK,GAAG,EAAZ;AACA,cAAIC,CAAC,GAAGtC,EAAE,EAAV;AACA,eAAKM,kBAAL,CAAwBiC,iBAAxB,CAA0CD,CAA1C;;AACA,kBAAOR,KAAK,CAACU,OAAb;AACI,iBAAKzC,OAAO,CAAC0C,KAAb;AACI;AACAH,cAAAA,CAAC,CAACI,CAAF,GAAM,CAACL,KAAP;AACAC,cAAAA,CAAC,CAACJ,CAAF,GAAM,CAAN;AACA;;AACJ,iBAAKnC,OAAO,CAAC4C,KAAb;AACI;AACAL,cAAAA,CAAC,CAACJ,CAAF,GAAM,CAACG,KAAP;AACAC,cAAAA,CAAC,CAACI,CAAF,GAAM,CAAN;AACA;;AACJ,iBAAK3C,OAAO,CAAC6C,KAAb;AACI;AACAN,cAAAA,CAAC,CAACI,CAAF,GAAML,KAAN;AACAC,cAAAA,CAAC,CAACJ,CAAF,GAAM,CAAN;AACA;;AACJ,iBAAKnC,OAAO,CAAC8C,KAAb;AACI;AACAP,cAAAA,CAAC,CAACJ,CAAF,GAAMG,KAAN;AACAC,cAAAA,CAAC,CAACI,CAAF,GAAM,CAAN;AACA;;AACJ,iBAAK3C,OAAO,CAAC+C,KAAb;AACI;AACA,kBAAG,KAAKrC,OAAR,EAAgB;AACZ,qBAAKH,kBAAL,CAAwByC,UAAxB,CAAmC/C,EAAE,CAAC,CAAD,EAAG,GAAH,EAAO,CAAP,CAArC;AACA,qBAAKS,OAAL,GAAe,KAAf;AACH;;AACD;AA3BR;;AA6BA,cAAGqB,KAAK,CAACU,OAAN,IAAezC,OAAO,CAAC+C,KAA1B,EAAgC;AAC5B7C,YAAAA,IAAI,CAAC+C,aAAL,CAAmBV,CAAnB,EAAqBA,CAArB,EAAuB,KAAKX,YAAL,CAAkBsB,gBAAlB,EAAvB;;AACA,gBAAGX,CAAC,CAACH,CAAF,GAAI,CAAP,EAAS;AACLG,cAAAA,CAAC,CAACH,CAAF,GAAM,CAAN;AACH;;AACD,iBAAK7B,kBAAL,CAAwB4C,iBAAxB,CAA0CZ,CAA1C;AACH;AAEJ;;AAEDjB,QAAAA,cAAc,CAACS,KAAD,EAAqB;AAAC;AAChC,kBAAOA,KAAK,CAACU,OAAb;AACI,iBAAKzC,OAAO,CAAC0C,KAAb;AACA,iBAAK1C,OAAO,CAAC4C,KAAb;AACA,iBAAK5C,OAAO,CAAC6C,KAAb;AACA,iBAAK7C,OAAO,CAAC8C,KAAb;AACI,mBAAKvC,kBAAL,CAAwB4C,iBAAxB,CAA0ClD,EAAE,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CAA5C;AALR;AAOH;;AAxHqC,O,UAsBxBY,Q,GAAsB,I;;;;;iBAnBtB,I;;;;;;;iBAGM,I;;;;;;;iBAGH,I","sourcesContent":["import { _decorator, Component, Node, input, Input, BoxCollider, RigidBody, EventKeyboard, KeyCode, EventMouse, v3, ICollisionEvent, Vec3, clamp } from 'cc';\nconst { ccclass, property } = _decorator;\n\n@ccclass('PlayerCtrl')\nexport class PlayerCtrl extends Component {\n    //玩家节点\n    @property(Node)\n    Player:Node = null !\n    //摄像机节点\n    @property(Node)\n    playerCamera:Node = null !   \n    //场景节点\n    @property(Node)\n    GameScene:Node = null !\n\n    //刚体组件\n    public RigidBodyComponent:RigidBody;\n    //碰撞箱组件\n    private ColliderComponent:BoxCollider;\n    //是否可以移动视角\n    private canMovePerspect = false;\n    //是否可以跳跃\n    private canJump = false;\n    //玩家视角\n    public playerAngel = v3();\n    // 单例\n    public static instance:PlayerCtrl = null!\n\n    start() {\n        // 绑定单例\n        PlayerCtrl.instance = this;\n        // 获取组件\n        this.RigidBodyComponent = this.Player.getComponent(RigidBody);\n        this.ColliderComponent = this.Player.getComponent(BoxCollider);\n        // 开启按键监听\n        input.on(Input.EventType.KEY_DOWN,this.playerStartMove,this);\n        input.on(Input.EventType.KEY_PRESSING,this.playerStartMove,this);\n        input.on(Input.EventType.KEY_UP,this.playerStopMove,this);\n        input.on(Input.EventType.MOUSE_MOVE,this.moveView,this);\n        input.on(Input.EventType.MOUSE_DOWN,()=>{\n            this.canMovePerspect = true;//按下鼠标后可以移动视角\n        },this);\n        input.on(Input.EventType.MOUSE_UP,()=>{\n            this.canMovePerspect = false;//松开鼠标后不能移动视角\n        },this);\n        // 开启碰撞检测\n        this.ColliderComponent.on(\"onCollisionEnter\",this.playerLand,this);\n        // 获取角度\n        this.playerCamera.worldRotation.getEulerAngles(this.playerAngel);\n    }\n\n    moveView(event:EventMouse){//移动视角\n        if(!this.canMovePerspect) return;//判断是否可以移动视角\n        let delta = event.getDelta();//鼠标移动距离，右上为正        \n        let percentage = 0.5;//灵敏度\n        let x = delta.x*percentage;\n        let y = delta.y*percentage;\n        if(this.playerAngel.y-x>180){\n            this.playerAngel.y -= 360;\n        }\n        else if(this.playerAngel.y-x<-180){\n            this.playerAngel.y += 360;\n        }\n        this.playerCamera.setWorldRotationFromEuler(clamp(this.playerAngel.x+y,-90,90),this.playerAngel.y-x,0);\n        this.playerCamera.worldRotation.getEulerAngles(this.playerAngel);//更新人物角度朝向信息供移动函数使用\n        \n    }\n\n    playerLand(event:ICollisionEvent){//玩家着陆\n        this.canJump = true;\n    }\n\n    // 这样的实现有bug，一次只能按一个键，按多了就会变得奇奇怪怪\n    playerStartMove(event:EventKeyboard){//玩家开始移动\n        let speed = 10;\n        let v = v3();\n        this.RigidBodyComponent.getLinearVelocity(v);\n        switch(event.keyCode){\n            case KeyCode.KEY_W:\n                // console.log(\"press W\");\n                v.z = -speed;\n                v.x = 0;\n                break;\n            case KeyCode.KEY_A:\n                // console.log(\"press A\");\n                v.x = -speed;\n                v.z = 0;\n                break;\n            case KeyCode.KEY_S:\n                // console.log(\"press S\");\n                v.z = speed;\n                v.x = 0;\n                break;\n            case KeyCode.KEY_D:\n                // console.log(\"press D\");\n                v.x = speed;\n                v.z = 0;\n                break;\n            case KeyCode.SPACE:\n                // console.log(\"press Space\");\n                if(this.canJump){\n                    this.RigidBodyComponent.applyForce(v3(0,300,0));\n                    this.canJump = false;\n                }\n                break;\n        }\n        if(event.keyCode!=KeyCode.SPACE){\n            Vec3.transformQuat(v,v,this.playerCamera.getWorldRotation());\n            if(v.y>0){\n                v.y = 0;\n            }\n            this.RigidBodyComponent.setLinearVelocity(v);\n        }\n        \n    }\n\n    playerStopMove(event:EventKeyboard){//玩家停止移动\n        switch(event.keyCode){\n            case KeyCode.KEY_W:\n            case KeyCode.KEY_A:\n            case KeyCode.KEY_S:\n            case KeyCode.KEY_D:\n                this.RigidBodyComponent.setLinearVelocity(v3(0,0,0));\n        }\n    }\n}\n"]}